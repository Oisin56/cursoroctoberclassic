rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is the current editor
    function isCurrentEditor(eventId) {
      let accessPath = /databases/$(database)/documents/events/$(eventId)/controls/access;
      return exists(accessPath) && 
             request.auth != null && 
             get(accessPath).data.currentEditorUid == request.auth.uid;
    }
    
    // Events collection - read by all, write by editor
    match /events/{eventId} {
      allow read: if true;
      allow write: if isCurrentEditor(eventId);
      allow create: if request.auth != null;
      
      // Controls subcollection for editor access management
      match /controls/access {
        allow read: if true;
        // Allow write if user is setting themselves as editor or releasing the lock
        allow write: if request.auth != null && 
                       (request.resource.data.currentEditorUid == request.auth.uid || 
                        request.resource.data.currentEditorUid == null);
        allow create: if request.auth != null;
      }
    }
    
    // Courses collection - read by all, write by authenticated editor
    match /courses/{courseId} {
      allow read: if true;
      // Allow write if user is authenticated and is the current editor
      allow write: if request.auth != null && isCurrentEditor('october-classic-2025');
      // Allow create during seeding
      allow create: if request.auth != null;
    }
    
    // Rounds collection - read by all, write by editor
    match /rounds/{roundId} {
      allow read: if true;
      allow write: if request.auth != null && isCurrentEditor(resource.data.eventId);
      allow create: if request.auth != null;
    }
    
    // Scores collection - read by all, write by editor
    match /scores/{scoreId} {
      allow read: if true;
      allow write: if request.auth != null && 
                     exists(/databases/$(database)/documents/rounds/$(resource.data.roundId)) &&
                     isCurrentEditor(get(/databases/$(database)/documents/rounds/$(resource.data.roundId)).data.eventId);
      allow create: if request.auth != null;
    }
  }
}
